## 2022.10.24 Django13



### ğŸ“ŒMany to many relationship

---

- RDB
  - M:N: í•œ í…Œì´ë¸”ì˜ 0ê°œ ì´ìƒ ë ˆì½”ë“œê°€ ë‹¤ë¥¸ í…Œì´ë¸”ì˜ 0ê°œ ì´ìƒì˜ ë ˆì½”ë“œì™€ ê´€ë ¨ëœ ê²½ìš°
  - ì–‘ìª½ ëª¨ë‘ì—ì„œ N:1 ê´€ê³„ë¥¼ ê°€ì§
  
- ë³‘ì› ì˜ˆì•½ ì‹œìŠ¤í…œ êµ¬ì¶•ì„ ìœ„í•œ ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸ë§ì„ ì§„í–‰í•œë‹¤ë©´?

- ì˜ì‚¬ IDì™€ í™˜ì IDë¥¼ 1:1 ë§¤ì¹­í•´ì„œ ì˜ˆì•½ í”„ë¡œê·¸ë¨ì„ ë§Œë“¤ ìˆ˜ ìˆì„ ê²ƒ,
  ê·¸ë˜ì„œ ì¤‘ê°œ í•„ë“œê°€ í•„ìš”í•  ê²ƒ.

- í•˜ì§€ë§Œ djangoì—ëŠ” ì´ë¥¼ ë³´ì™„í•˜ê¸° ìœ„í•´ modelsì—ì„œ manytomanyFieldë¥¼ ì œê³µí•¨

  - `manytomanyfieldëŠ” ì¤‘ê°œ í…Œì´ë¸”ì„ ìë™ìœ¼ë¡œ ìƒì„±í•´ì¤Œ`
  - ì¹¼ëŸ¼ì„ ë§Œë“¤ë©´ í•´ë‹¹ ì¹¼ëŸ¼ì˜ id ê°’ì„ ê°€ì§„ ì¹¼ëŸ¼ì„ ìë™ìœ¼ë¡œ ìƒì„±í•´ì¤Œ
  - ì§ì ‘ ì°¸ì¡°ë¥¼ í•˜ëŠ” ëª¨ë¸ê³¼ manytomanyField ëª¨ë¸ì˜ í…Œì´ë¸” êµ¬ì¡°ëŠ” ë˜‘ê°™ìœ¼ë‚˜ ì°¸ì¡°í•˜ëŠ” ë°©í–¥ì´ ë‹¤ë¦„!
  - ì§ì ‘ ì°¸ì¡°, manytomanyFieldëŠ” ì—­ì°¸ì¡°

- ì½”ë“œ ì˜ˆì‹œ

  ```python
  # hospitals/models.py - ì§ì ‘ ì°¸ì¡°
  # ì™¸ë˜í‚¤ ì‚­ì œ
  class Patient(models.Model):
  	name = models TextField
  	
      def __str__(self):
          return f'{self.pk}ë²ˆ í™˜ì {self.name}'
  
  # ì¤‘ê°œëª¨ë¸ ì‘ì„±
  class Reservation(models.Model):
  	doctor = models.ForeignKey(Doctor, on_delete=models.CASCADE)
  	patient = models.ForeignKey(Patient, on_delete=models.CASCADE)
  	
      def __str__(self):
          return f'{self.doctor_id}ë²ˆ ì˜ì‚¬ì˜ {self.patient_id}ë²ˆ í™˜ì'
  ```

  

  ```python
  # hospitals/models.py - manytomanyField í™œìš©
  class Patient(models.Model):
  	# ManyToManyField ì‘ì„±
  	doctors = models.ManyToManyField(Doctor)
  	name = models.TextField()
      
      def __str__(self):
          return f'{self.pk}ë²ˆ í™˜ì {self.name}'
  ```

  

- í•˜ì§€ë§Œ ì¤‘ê°œëª¨ë¸ì„ ì‘ì„±í•´ì•¼í•˜ëŠ” ê²½ìš°ë„ ìˆìŒ!

  - manytomanyëŠ” ì˜ì‚¬ ì—¬ëŸ¬ëª…ì—ê²Œ ë‹¤ìˆ˜ì˜ í™˜ìê°€ ì˜ˆì•½í•˜ëŠ”ê²ƒì²˜ëŸ¼ ë‘ê°œì˜ ì»¬ëŸ¼ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ í™œìš©

  - ì¤‘ê°œëª¨ë¸ì˜ ê²½ìš° í™˜ìì˜ ë‹´ë‹¹ì˜ì‚¬ì™€ ì˜ˆì•½ì‹œê°„, ìƒë‹´ë‚´ìš© ë“± ì—¬ëŸ¬ ì»¬ëŸ¼ì˜ ì •ë³´ë¥¼ ë‹´ì„ ë•Œì—ëŠ” ì¤‘ê°œëª¨ë¸ ì‚¬ìš©

  - manytomnayfieldì—ì„œ through ì˜µì…˜ì„ í™œìš©í•˜ì—¬ ì¤‘ê°œëª¨ë¸ì„ í™œìš©

    ```python
    # hospitals/models.py - manytomanyField í™œìš©
    
    class Patient(models.Model):
    	doctors = models.ManyToManyField(Doctor, through='Reservation')
    	name = models.TextField()
        
    	def __str__(self):
            return f'{self.pk} ë²ˆ í™˜ì {self.name}'
        
    class Reservation(models.Model):
    	doctor = models.ForeignKey(Doctor, on_delete=models.CASCADE)
    	patient = models.ForeignKey(Patient, on_delete=models.CASCADE)
    	symptom = models.TextField()
    	reserved_at = models.DateTimeField(auto_now_add=True)
    	
        def __str__(self):
    	return f'{self.doctor.pk}ë²ˆ ì˜ì‚¬ì˜ {self.patient.pk} ë²ˆ í™˜ì
    ```

- related_name: ì—­ì°¸ì¡°ë¥¼ ì–´ë–»ê²Œ ë¶€ë¥¼ ê·¸ ê°’ì„ ì§€ì •í•˜ëŠ” ì˜µì…˜





## ğŸ“Œ "ì¢‹ì•„ìš”" ê¸°ëŠ¥ êµ¬í˜„

- DB ì¢‹ì•„ìš”ë¥¼ ì–´ë–»ê²Œ ê¸°ë¡í•  ê²ƒì¸ì§€?

  - Article(M) - User(N)
  - Articleì€ 0ëª… ì´ìƒì˜ Userì—ê²Œ ì¢‹ì•„ìš”ë¥¼ ë°›ëŠ”ë‹¤.
  - UserëŠ” Article 0ê°œ ì´ìƒì˜ ê¸€ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¼ ìˆ˜ ìˆë‹¤.

  ```python
  # articles/models.py
  ...
  from django.conf import settings
  ...
  
  class Article(models.Model):
      ...
      like_users = models.ManyToManyField(settigns.AUTH_USER_MODEL, related_name='like_articles')
  ```

  

- ë¡œì§ì€ ì–´ë–»ê²Œ ì‘ì„±í•  ê²ƒì¸ê°€?

  - ìƒì„¸ë³´ê¸° í˜ì´ì§€ì—ì„œ ì¢‹ì•„ìš” ë§í¬ë¥¼ ëˆ„ë¥´ë©´ ì¢‹ì•„ìš”ë¥¼ ì¶”ê°€í•˜ê³  ë‹¤ì‹œ ìƒì„¸ë³´ê¸° í˜ì´ì§€ë¡œ redirect
  - ìƒì„¸ë³´ê¸° í˜ì´ì§€ URL: `<int:pk>/like`
  - user ì •ë³´ëŠ” request.userë¡œ ê°€ì ¸ì˜¬ ì˜ˆì •

  ```python
  # articles/urls.py
  ...
  
  urlpatterns = [
      path('<int:pk>/like/', views.like, name='like'),
  ]
  ```

  ```python
  # articles/views.py
  ...
  def like(request, pk):
      article = Article.objects.get(pk=pk)
      # ë§Œì•½ì— ë¡œê·¸ì¸í•œ ìœ ì €ê°€ ì´ ê¸€ì„ ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ë‹¤ë©´,
      if request.user in article.like_users.all():
          # ì¢‹ì•„ìš” ì‚­ì œí•˜ê³ 
          article.like_users.remove(request.user)
      else:
          # ì¢‹ì•„ìš” ì¶”ê°€í•˜ê³ 
          article.like_users.add(request.user)
      # ìƒì„¸ í˜ì´ì§€ë¡œ redirect
      return redirect('articles:detail', pk)
  ```

  ```html
  <!-- articles/templates/articles/detail.html -->
  ...
  
  <a href="{% url 'articles:like' article.pk %}">
  {% if request.user in article.like_users.all %}
  ì¢‹ì•„ìš” ì·¨ì†Œ
  {% else %}
  ì¢‹ì•„ìš”
  {% endif %}
  </a> | <span>{{ article.like_users.count }}</span>
  ...
  ```

  
