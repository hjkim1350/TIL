## 2022.10.25 Django14 - íŒ”ë¡œìš° ê¸°ëŠ¥ êµ¬í˜„



### ğŸ“Œë³µìŠµ

---

- DB ëª¨ë¸ ê´€ê³„ì— ë”°ë¥¸ ì¿¼ë¦¬ì…‹

```text
- A.B_set.all() : A(1):B(N)

- C.Ds.all(): C(M):D(N)

- e.f.all(): E(N):F(1)
  - ë‹¤ì¤‘ì°¸ì¡°ì‹œ namingì„ ë³µìˆ˜í˜•(s)ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ë‹¨ì¼ ì°¸ì¡°ì‹œ ë‹¨ìˆ˜í˜•ìœ¼ë¡œ naming í•˜ëŠ” ê²ƒì´ ì•”ë¬µì ì¸ ë£°
```



- get VS filter

```text
get: ì¿¼ë¦¬ì— ë§ëŠ” ê°ì²´ í•˜ë‚˜([0]ë²ˆì§¸)ë§Œ ë°˜í™˜
filter: ì¿¼ë¦¬ì— ë§ëŠ” ì¿¼ë¦¬ì…‹ì„ ë°˜í™˜
```



- CRUD

```text
save(): DBì— ì‹¤ì œ ì €ì¥ë˜ëŠ” ë°©ì‹
delete(): DBì—ì„œ ì‚­ì œ
```





### ğŸ“Œ M:N (user:user) ëª¨ë¸ì„ ì´ìš©í•œ íŒ”ë¡œìš° ê¸°ëŠ¥ êµ¬í˜„

---

```python
# models.py ì˜ˆì‹œ
...
class User(AbstractUser):
    # selfê°€ ë“¤ì–´ê°€ëŠ” ì´ìœ ëŠ” íŒ”ë¡œìš°ëŠ” user:userë¡œ ì´ë£¨ì–´ì§€ëŠ” êµ¬ì¡°ì´ê¸° ë•Œë¬¸
    # ManyToManyFieldì—ì„œ selfê°€ ì‚¬ìš©ë  ë•Œì—ë§Œ symmentrical ì˜µì…˜ì´ ì‚¬ìš©ë¨.
    followings = models.ManyToManyField('self', symmentrical=False, related_name='followers')
```



- symmentrical ì˜µì…˜ì˜ ì‚¬ìš©ë²•

  - íŒ”ë¡œì‰: symmentrical = False
    - user Aê°€ ë‹¤ë¥¸ user Bì˜ ê²Œì‹œê¸€ì„ êµ¬ë…í•¨
    - B ì…ì¥ì—ì„œëŠ” íŒ”ë¡œì›Œë¡œ Aê°€ ë“±ë¡ë¨

  - ì‹¸ì´ì›”ë“œì˜ ê²½ìš° ì¼ì´Œì„ ì„œë¡œ ë§ºì–´ì•¼ ì¼ì´Œì´ë¨: symmentrical = True

- íŒ”ë¡œì‰ ê¸°ëŠ¥ êµ¬í˜„

  - ì‚¬ìš©ì í”„ë¡œí•„ì— ë“¤ì–´ê°€ì„œ íŒ”ë¡œìš°ë¥¼ ëˆ„ë¥´ë©´ ì¶”ê°€ (add)
  - íŒ”ë¡œìš° ìƒíƒœì´ë©´ ''íŒ”ë¡œìš° ì·¨ì†Œ'' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‚­ì œ (remove)
  - URL: `accounts/<int:user_pk>/follow`
  - ì²˜ë¦¬ ì™„ë£Œë˜ë©´ ì‚¬ìš©ì í˜ì´ì§€ë¡œ redirect
  - (ì¶”ê°€ì‚¬í•­) ì…€í”„ íŒ”ë¡œìš°ëŠ” í—ˆìš©í•  ìˆ˜ ì—†ìŒ

```python
# accounts/urls.py
...
url_patterns = [
    path('<int:user_pk>/follow/', views.follow, name='follow'),
]
```



```python
# accounts/views.py
...
# add - ë¡œê·¸ì¸í•œ ìœ ì €ê°€ í”„ë¡œí•„ì˜ ìœ ì €ì˜ íŒ”ë¡œì›Œì— ì¶”ê°€
def follow(request, pk):
    # user ì¿¼ë¦¬ì…‹ ê°€ì ¸ì˜¤ê¸°
    User = get_user_model()
    user = User.objects.get(pk=pk)
    
    # ìš”ì²­í•œ ìœ ì €ê°€ í”„ë¡œí•„ì˜ ìœ ì €ì™€ ë™ì¼í•˜ë‹¤ë©´ detail í˜ì´ì§€ë¡œ redirect
    if request.user == user:
        messages.warning('accounts:detail', pk)
        return redirect('accounts:detail', pk)
    
    # í”„ë¡œí•„ ìœ ì €ì˜ íŒ”ë¡œì›Œë“¤ì— ìš”ì²­í•œ ìœ ì €ê°€ ìˆëŠ”ì§€ í™•ì¸ 
    if request.user in user.followers.all():
        user.followers.add(request.user)
    return redirect('accounts:detail', pk)
```



```html
<!-- accounts/templates/accounts/detail.html -->
...
<p>
    íŒ”ë¡œìš°: {{ user.followings.count }} |  íŒ”ë¡œì›Œ: {{ user.followers.count }}
</p>

<!-- íŒ”ë¡œìš° ìš”ì²­í•œ ìœ ì €ê°€ í”„ë¡œí•„ì˜ ìœ ì €ê°€ ì•„ë‹ˆë¼ë©´ íŒ”ë¡œìš° ì·¨ì†Œ/íŒ”ë¡œìš° ë²„íŠ¼ ì¶œë ¥ -->
{% if request.user != user %}
<a href={% url 'accounts:follow' user.pk %}>
    {% if request.user in user.followers.all %}
    	íŒ”ë¡œìš° ì·¨ì†Œ
    {% else %}
    	íŒ”ë¡œìš°
    {% endif %}
</a>

...
```





### ğŸ“Œ view decorators & functions

---

- Q) views.pyëŠ” htmlì„ ë°˜í™˜í• ê¹Œ?
  - A) htmlì„ ì‘ë‹µí•˜ëŠ”ê²ƒì´ ì•„ë‹Œ response ê°ì²´ë¥¼ ì‘ë‹µí•˜ëŠ” ê²ƒ!
  - https://developer.mozilla.org/en-US/docs/Learn/Server-side/Django/Introduction
  - í•˜ê¸°ì˜ ê·¸ë¦¼ì„ ë³´ë©´ ê²°êµ­ì€ viewëŠ” modelì„ ì°¸ì¡°í•˜ê³  templateë¥¼ ì°¸ì¡°í•´ì„œ ì‚¬ìš©ìë¡œë¶€í„° ìš”ì²­ë˜ì–´ì˜¨ requestë¥¼ ë°›ì•„ responseë¥¼ ì‘ë‹µí•´ì£¼ëŠ” êµ¬ì¡°ì„. 
  - ![image-20221104005512641](20221025_Django14.assets/image-20221104005512641.png)



- ì´ì œê¹Œì§€ views.pyì—ì„œ return ê°’ìœ¼ë¡œ renderì™€ requestë¥¼ ì‘ë‹µí–ˆë‹¤ë©´, ë‹¤ë¥¸ êµ¬ì¡°ë„ ì¡´ì¬í•¨.

  - render: status code 2xx í•´ë‹¹
  - redirect: status code 3xx í•´ë‹¹
    - @login_required: status code 200ì— í•´ë‹¹í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ
    - redirectëŠ” GET ìš”ì²­ë§Œ ê°€ëŠ¥í•¨. ì¦‰, URLë§Œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•´ì£¼ì§€ ë°ì´í„° ìì²´ë¥¼ ì „ë‹¬í•˜ì§„ ì•ŠìŒ.
  - í˜ì´ì§€ê°€ ì—†ëŠ”ë° URLë¡œ ê°•ì œ í˜¸ì¶œí•˜ë©´ 404 Page not foundë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŒ
  - 500ë²ˆëŒ€ ì—ëŸ¬ ì¶œë ¥ì€? ì„œë²„ì—ì„œ ì˜¤íƒ€ë¥¼ ë‚´ê±°ë‚˜ í•˜ëŠ” ë“± ì„œë²„ ì„¤ì •ì—ëŸ¬. Internal server error
  - 500ë²ˆ ì—ëŸ¬ ì¶œë ¥ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ djangoëŠ” shortcutìœ¼ë¡œ ë§Œë“¤ì–´ë‘ 
    (https://docs.djangoproject.com/en/4.1/topics/http/shortcuts/)
  - í•˜ê¸° ì½”ë“œë¥¼ ì‚¬ìš©í•˜ê³  ì˜ˆë¥¼ ë“¤ì–´ 100ë²ˆ ê²Œì‹œê¸€ ê¹Œì§€ë§Œ ìˆëŠ” ê²Œì‹œíŒì— 500ë²ˆ ê²Œì‹œê¸€ì„ ìš”ì²­í•˜ë©´,
    500ë²ˆ ì—ëŸ¬ë¥¼ ì¶œë ¥í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ 404 Page not foundë¥¼ ì¶œë ¥í•´ì¤Œ.
    - ì´ëŠ” ì„œë²„ì˜ ì„¤ì •ì„ ë…¸ì¶œí•˜ì§€ ì•Šê¸° ìœ„í•œ ë°©ë²•ì¸ë“¯ í•¨.
    - Article.objects.get(pk=pk)ì²˜ëŸ¼ getìœ¼ë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” êµ¬ë¬¸ì„ get_object_or_404(Article, pk=pk)ì²˜ëŸ¼ ë³€ê²½í•´ì£¼ë©´ ë¨!

  ```python
  # views.py
  
  ...
  from django.shortcuts import render, redirect, get_object_or_404
  ...
  
  def detail(request, pk):
      ...
      article = get_object_or_404(Article, pk=pk)
  ```

  



- @require_POST ë°ì½”ë ˆì´í„°

  - "í˜ì´ì§€ê°€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"ë¡œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì™„í™”ì‹œì¼œì¤Œ

  ```python
  # views.py
  
  ...
  from django.views.decorators.http import require_POST
  ...
  
  @require_POST
  ```

- @require_GET, @require_safe ë“±ì˜ ë°ì½”ë ˆì´í„°ë„ ì¡´ì¬!



### ğŸ’¡í™œìš©í•˜ê¸° ìœ ìš©í•œ ì‚¬ì´íŠ¸

---

- POSTMAN: https://www.postman.com/



â­ Javascriptë¥¼ ì´ìš©í•œ ë¡œë˜ ìƒì„± í”„ë¡œê·¸ë¨ ì½”ë“œë¥¼ ìˆ™ì§€í•˜ê³  ì˜¬ ê²ƒ.
